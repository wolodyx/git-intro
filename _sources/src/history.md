# Изучение истории


## Введение

<!-- Количество коммитов в истории -->
В хранилищах малых проектов в среднем около нескольких сотен и тысяч коммитов, средних проектов -- десятки тысяч, а крупных -- сотни тысяч и миллионы.
Эти числа получаются из 4 коммита в день на разработчика и 250 рабочих дней в году.
<!-- Важность изучения истории -->
Коммиты интересны не только с точки зрения количественных показателей.
История коммитов отвечает на следующие вопросы:
* кто чем занимается в команде;
* кто как работает;
* что изменилось в программе за последнее время;
* кто изменил этот файл;
* кто добавил эту функцию;
* кто и когда внес ошибку в программу;
* насколько интенсивно идет работа над проектом;
* зачем был добавлен этот код?
* и некоторые другие специфические вопросы.

<!-- Про команду `git log` -->
Ответы на эти вопросы можно получить только если вы владеете инструментом по анализу коммитов -- командой `git log`.

Команда `git log` без аргументов покажет всю историю коммитов проекта в порядке обратном их созданию.
Последний коммит в проекте будет самым первым в списке, а первый коммит -- самым последним.
Если вывод команды не помещается на экран, то он перенаправится в пейджер `less`.
Выход из пейджера происходит по команде `q`.

``` text
commit 317d080fd9d7d66955e4bc2055a08b4edb044cf1 (HEAD -> main, origin/main, origin/HEAD)
Author: wolodyx <wolodyx@yandex.ru>
Date:   Thu Mar 9 08:42:24 2023 +0300

    Исправлена утечка серверного сокета

commit 8e36f074fb3374c6d0007c934765d3f6a17d955e
Author: wolodyx <wolodyx@yandex.ru>
Date:   Wed Mar 8 14:23:38 2023 +0300

    Закрытие клиентских сокетов на стороне сервера

commit ea3a417d17049d6b450a0076d82898f964213b6c
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 10:56:31 2023 +0300

    Автоматическое закрытие клиента при потере связи с сервером

commit cef81ca4ebe0494e20e7cd42a13621a06ec1c96b
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 10:41:23 2023 +0300

    Код для управления лампой и работы с командами собрали в классах

commit 7f65d0568d2bcda05cfcf76011e80c9596d07abc
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 09:42:05 2023 +0300

    LampClient -> Lamp

commit bff68c5a8e25d6d3be5f4e2ec819ba87a908aed4
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 09:13:29 2023 +0300

    Документирование кода

commit 0be6caaf1a6d3c1744b307ab863a6693f81f09e9
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 08:52:58 2023 +0300

    Инструкции по сборке и использованию программы

commit 459d140a7e7962bbcae47555c570033eea0d6bf6
Author: wolodyx <wolodyx@yandex.ru>
Date:   Sat Mar 4 08:38:18 2023 +0300

    Функционирующий код программы

commit 49b5bac3ae3de3f26606c6ba7b8f7eb85bb558d8
Author: Владимир <wolodyx@yandex.ru>
Date:   Sat Mar 4 08:18:44 2023 +0300

    Initial commit
```

## Формат вывода команды

<!-- Формат вывода по умолчанию -->
Изучим вывод команды.
С каждым коммитом связано 40-разрядное шестнадцатеричное число, называемое *хеш-суммой* или кратко *хешем*.
Хеш-сумма уникальна для коммитов в пределах хранилища, т.е. в одном хранилище нет двух коммитов с совпадающей хеш-суммой.
Это число позволяет сослаться на коммит.
Поле `commit` содержит хеш-сумму в выводе.
Поле `Author` отображает данные автора коммита -- его имя и адрес электронной почты.
В поле `Date` указаны дата и время коммита в формате дня недели, названия месяца, числа, времени, года и часового пояса.
Сообщение к коммиту.

<!-- Изменение формата вывода -->
Формат вывода настраивается опциями команды `git log`:
* `--pretty`;
* `--patch`;
* `--stat`;
* `--relative-date`.

Опция `--pretty`:
предопределенные форматы `oneline`, `short`, `full` и `fuller`:

Формат `--pretty=oneline`, как вытекает из названия, выводит информацию о коммите компактно одной строкой, содержащей только хеш-сумму и сообщение коммита.
Однострочный вывод также доступен опцией `--oneline`, но только в этом случае хеш коммита дана в сокращенном виде.

``` bash
skt@home:~/MyProjects/RemoteLamps$ git log --pretty=oneline
317d080fd9d7d66955e4bc2055a08b4edb044cf1 (HEAD -> main, origin/main, origin/HEAD) Исправлена утечка серверного сокета
8e36f074fb3374c6d0007c934765d3f6a17d955e Закрытие клиентских сокетов на стороне сервера
ea3a417d17049d6b450a0076d82898f964213b6c Автоматическое закрытие клиента при потере связи с сервером
cef81ca4ebe0494e20e7cd42a13621a06ec1c96b Код для управления лампой и работы с командами собрали в классах
7f65d0568d2bcda05cfcf76011e80c9596d07abc LampClient -> Lamp
bff68c5a8e25d6d3be5f4e2ec819ba87a908aed4 Документирование кода
0be6caaf1a6d3c1744b307ab863a6693f81f09e9 Инструкции по сборке и использованию программы
459d140a7e7962bbcae47555c570033eea0d6bf6 Функционирующий код программы
49b5bac3ae3de3f26606c6ba7b8f7eb85bb558d8 Initial commit
```

Формат `--pretty=short` расширяет предыдущий вывод информацией об авторе коммита.

``` bash
skt@home:~/MyProjects/RemoteLamps$ git log --pretty=short
commit 317d080fd9d7d66955e4bc2055a08b4edb044cf1 (HEAD -> main, origin/main, origin/HEAD)
Author: wolodyx <wolodyx@yandex.ru>

    Исправлена утечка серверного сокета

commit 8e36f074fb3374c6d0007c934765d3f6a17d955e
Author: wolodyx <wolodyx@yandex.ru>

    Закрытие клиентских сокетов на стороне сервера

commit ea3a417d17049d6b450a0076d82898f964213b6c
Author: wolodyx <wolodyx@yandex.ru>

    Автоматическое закрытие клиента при потере связи с сервером

commit cef81ca4ebe0494e20e7cd42a13621a06ec1c96b
Author: wolodyx <wolodyx@yandex.ru>

    Код для управления лампой и работы с командами собрали в классах

commit 7f65d0568d2bcda05cfcf76011e80c9596d07abc
Author: wolodyx <wolodyx@yandex.ru>

    LampClient -> Lamp

commit bff68c5a8e25d6d3be5f4e2ec819ba87a908aed4
Author: wolodyx <wolodyx@yandex.ru>

    Документирование кода

commit 0be6caaf1a6d3c1744b307ab863a6693f81f09e9
Author: wolodyx <wolodyx@yandex.ru>

    Инструкции по сборке и использованию программы

commit 459d140a7e7962bbcae47555c570033eea0d6bf6
Author: wolodyx <wolodyx@yandex.ru>

    Функционирующий код программы

commit 49b5bac3ae3de3f26606c6ba7b8f7eb85bb558d8
Author: Владимир <wolodyx@yandex.ru>

    Initial commit
```

Опции `--pretty=full` и `--pretty=fuller` добавляют поля об авторе и коммитере соответственно.
<!-- Отличие автора от коммитера -->
Автор коммита -- это участник разработки, оформивший изменения, а коммитер -- внесший их в хранилище.
Обычно роли автора и коммитера играет один человек, который оформляет и фиксирует изменения.
Но процесс разработки открытого ПО отличается от коммерческого, где не все авторы имеют доступ к официальному хранилищу.
Тогда они предлагают свои изменения через патчи.
Коммитер оценивает изменения, и если они устраивают его, вносит их в хранилище от своего имени.
При этом имя автора сохраняется.
Простой пример, где автор и коммитер разные участники -- это первый коммит при создании хранилища из веб-интерфейса `GitHub`.
Система первым коммитом добавляет файлы лицензии и `README.md` от своего имени, но с данных, запрошенных от автора.

``` text
commit 49b5bac3ae3de3f26606c6ba7b8f7eb85bb558d8
Author:     Владимир <wolodyx@yandex.ru>
AuthorDate: Sat Mar 4 08:18:44 2023 +0300
Commit:     GitHub <noreply@github.com>
CommitDate: Sat Mar 4 08:18:44 2023 +0300

    Initial commit
```

Опция `--pretty` дополнительно предлагает возможность задания собственного формата:
`git log --pretty=format:"строка формата"`
В строке формата указывают опции, которые при выводе заменяются полями коммита.
Вот некоторые из них:

| Опция |         Описание         |
|-------|--------------------------|
|  %H   | Хеш коммита              | 
|  %h   | Сокращенный хеш коммита  | 
|  %an  | Имя автора               | 
|  %ae  | Электронная почта автора | 
|  %ad  | Дата автора              | 
|  %s   | Содержание               | 

Введем собственный компактный формат отображения, где в одной строке указаны имя автора и сообщение, разделенные символами `==>`.
Применим команду к хранилищу проекта [json](https://github.com/nlohmann/json.git) от пользователя [nlohmann](https://github.com/nlohmann).

``` bash
skt@home:~/MyProjects/json$ git log --pretty=format:"%an ==> %s"
Raphael Grimm ==> Prevent memory leak when exception is thrown in adl_serializer::to_json (#3901)
dependabot[bot] ==> ⬆️ Bump future from 0.18.2 to 0.18.3 in /docs/mkdocs (#3934)
Joyce ==> Refactor amalgamation workflow to avoid dangerous use of pull_request_target (#3969)
Sergei Trofimovich ==> custom allocators: define missing 'rebind' type (#3895)
theevilone45 ==> Fix typo in test.cmake (#3951)
Arsen Arsenović ==> tests/unit-iterators2: use std::ranges::equals for range comparisons (#3950)
haadfida ==> removed lgtm badge and added Cirrus CI badge (#3937)
Florian Segginger ==> Change 2022 to 2023 (#3932)
Raphael Grimm ==> Fix CI issues (#3906)
Finkman ==> PrettyPrinter: Check if match is valid before accessing group (#3920)
Niels Lohmann ==> Try old MinGW script (#3892)
Niels Lohmann ==> Upgrade Python packages (#3891)
Niels Lohmann ==> Fix warning about moved from object (#3889)
Niels Lohmann ==> Remove a magic number (#3888)
Niels Lohmann ==> Add migration guide (#3887)
Niels Lohmann ==> Clang 15 (#3876)
:
```


## Фильтрация коммитов

Коммит содержит следующие поля, на которые можно наложить условия для фильтрации:
* информация об авторе (имя и электронная почта);
* дата и время подготовки изменений;
* информация о коммитере (имя и электронная почта);
* дата и время фиксации изменений в хранилище.
* изменения в файлах;
* сообщение, описывающее изменения;

<!-- Фильтрация по автору -->
Поиск по автору:
`git log --author="имя автора"`
`git log --committer="имя коммитера"`

Показ последних нескольких коммитов (напримре, трех):
`git log -3`

<!-- Фильтрация по времени фиксации -->
Поиск по времени опциями `--after` и `--before`.
Первая из них показывает 

<!-- Фильтрация по ключевому слову в сообщении -->
Поиск по ключевому слову в сообщении коммита:
`git log --grep="ключевое слово"`

<!-- Фильтрация по ключевому слову в изменениях -->
Поиск по ключевому слову в тексте изменений:
`git log -S="ключевое слово"`

<!-- Фильтрация по измененным файлам -->
Поиск в выбранном файле:
`git log -- путь/к/файлу`


## Комбинация опций

Фильтрация коммитов и отображение форматом вывода команды `git log` часто применяют совместно.
Если мы ищем коммиты по автору, нас не интересует вывод поля о нем.

<!-- Ссылка на коммит -->

<!--
Команды ниже следует показать после темы о ветках.
`git log --graph`
`git log --no-merges`
-->

<!--
Что такое история изменений?
Каждый коммит, кроме самого первого, основывается на предыдущем, и их связи образуют историю изменений.
-->

## Контрольные вопросы

1. Повторите вывод `git log --oneline`, опцией `--pretty` с собственным форматом.
  Опции для управления цветом символов описаны в справочной странице к `git log` в разделе `PRETTY FORMATS`.


## Упражнения

1.

